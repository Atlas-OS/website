---
import { Image } from 'astro:assets';
import AtlasLogomark from '@/assets/atlas-logomark.svg';
import LanguageSwitcher from '@/components/core/LanguageSwitcher.astro';
import NavLink from '@/components/ui/NavLink.astro';
import IconButton from '@/components/ui/IconButton.astro';
import SearchButton from '@/components/ui/SearchButton.astro';
import SocialIconLink from '@/components/ui/SocialIconLink.astro';
import { getCurrentLocale } from '@/utils/locale';
import '@/styles/navbar.css';

interface Props {
  currentPath?: string;
  locale?: string;
  isDocsPage?: boolean;
}

const { currentPath = '/', locale, isDocsPage } = Astro.props;

const currentLocale = locale || getCurrentLocale(currentPath);

const isOnDocsPage = isDocsPage ?? currentPath.startsWith('/docs');

function isActive(href: string, currentPath: string): boolean {
  const normalizedHref = href.replace(/\/$/, '') || '/';
  const normalizedPath = currentPath.replace(/\/$/, '') || '/';

  if (normalizedHref === '/') {
    return normalizedPath === '/';
  }
  if (normalizedHref === '/docs/' || normalizedHref === '/docs') {
    return normalizedPath === '/docs/' || normalizedPath === '/docs';
  }
  return normalizedPath.startsWith(normalizedHref);
}

const mainNavItems = [
  { label: 'Documentation', href: '/docs/', isExternal: false },
  { label: 'Installation', href: '/docs/install/', isExternal: false },
  { label: 'FAQ', href: '/docs/faq/', isExternal: false },
  { label: 'Support us', href: 'https://ko-fi.com/atlasos', isExternal: true },
];
---

<header
  id="main-header"
  class="bg-background sticky top-0 z-50 w-full border-b border-white/10 backdrop-blur-sm transition-all duration-300"
  style="background-color: oklch(0.12 0.0421 264.82 / 0.8);"
>
  <div class="mx-auto flex h-14 items-center justify-between px-4 sm:px-6">
    <div class="flex min-w-0 flex-1 items-center gap-6">
      <a
        href="/"
        aria-label="AtlasOS Home"
        class="group flex shrink-0 items-center transition-opacity hover:opacity-80"
      >
        <div class="relative">
          <Image
            src={AtlasLogomark}
            alt="AtlasOS"
            width={100}
            height={32}
            class="relative z-10 block h-6 w-auto"
            loading="eager"
            decoding="async"
            fetchpriority="high"
          />
          <div
            class="bg-primary/10 group-hover:bg-primary/20 absolute -inset-2 -z-10 rounded-full opacity-70 blur-lg transition-all duration-300"
          >
          </div>
        </div>
      </a>

      <nav class="hidden items-center gap-1 lg:flex">
        <NavLink href="/docs/" isActive={isOnDocsPage || isActive('/docs/', currentPath)}> Documentation </NavLink>

        {
          mainNavItems.slice(1).map((item) => (
            <NavLink href={item.href} isActive={isActive(item.href, currentPath)} external={item.isExternal}>
              {item.label}
            </NavLink>
          ))
        }
      </nav>
    </div>

    <div class="flex shrink-0 items-center gap-3">
      {
        isOnDocsPage && (
          <>
            <SearchButton />
            <SearchButton mobile={true} />
          </>
        )
      }

      <LanguageSwitcher currentLocale={currentLocale} currentSlug={currentPath} />

      <div class="hidden items-center gap-2 sm:flex">
        <SocialIconLink href="https://github.com/Atlas-OS/Atlas" icon="tabler:brand-github" label="GitHub" />
        <SocialIconLink href="https://discord.com/invite/atlasos" icon="tabler:brand-discord" label="Discord" />
        <SocialIconLink href="https://x.com/atlasos" icon="tabler:brand-x" label="X (Twitter)" />
      </div>

      {
        isOnDocsPage ? (
          <IconButton
            id="sidebar-toggle-button"
            icon="tabler:menu-2"
            label="Toggle sidebar"
            controls="sidebar"
            expanded={false}
            class="lg:hidden"
          />
        ) : (
          <IconButton
            id="mobile-menu-button"
            icon="tabler:menu-2"
            label="Toggle mobile menu"
            controls="mobile-menu"
            expanded={false}
            class="relative md:hidden"
          />
        )
      }
    </div>
  </div>

  {
    !isOnDocsPage && (
      <div id="mobile-menu" class="hidden border-t border-white/10 md:hidden">
        <div
          id="mobile-menu-content"
          class="space-y-1 px-4 py-3 backdrop-blur-xl transition-all duration-300"
          style="background-color: oklch(0.12 0.0421 264.82 / 0.95);"
        >
          {mainNavItems.map((item) => (
            <a
              href={item.href}
              target={item.isExternal ? '_blank' : undefined}
              rel={item.isExternal ? 'noopener noreferrer' : undefined}
              class={`block rounded-md px-4 py-2.5 text-sm font-medium text-white transition-colors duration-200 ${
                isActive(item.href, currentPath) ? 'text-primary bg-white/5' : 'hover:bg-white/5'
              }`}
            >
              {item.label}
            </a>
          ))}
        </div>
      </div>
    )
  }
</header>

<script>
  import { initNavbar } from '@/utils/navbar';

  document.addEventListener('astro:page-load', initNavbar);
  initNavbar();
</script>
